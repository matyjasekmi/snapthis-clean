<!DOCTYPE html>
<html>
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><title><%= product.title %></title></head>
<body>
  <main>
    <h1><%= product.title %></h1>
    <p><%= product.description %></p>
    <div>Price: <%= product.price %></div>
    <form id="checkout-form" action="/checkout" method="post">
      <input type="hidden" name="productId" value="<%= product.id %>" />
      <input id="checkout-submit" type="submit" value="Przejdź do płatności">
    </form>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        const form = document.getElementById('checkout-form');
        const pubKey = "<%= process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY || '' %>";
        if (!pubKey) return; // fallback: no client-side stripe
        const stripeClient = Stripe(pubKey);
        form.addEventListener('submit', async function(e){
          e.preventDefault();
          const submit = document.getElementById('checkout-submit');
          submit.disabled = true;
          submit.value = 'Przekierowanie...';
          const data = new URLSearchParams(new FormData(form));
          try {
            const resp = await fetch('/create-checkout-session', { method: 'POST', body: data });
            if (!resp.ok) { throw new Error('Checkout creation failed'); }
            const json = await resp.json();
            if (json.sessionId) {
              const { error } = await stripeClient.redirectToCheckout({ sessionId: json.sessionId });
              if (error) console.error('Stripe redirect error', error);
            } else if (json.url) {
              window.location = json.url;
            }
            submit.disabled = false;
            submit.value = 'Przejdź do płatności';
          } catch (err) { console.error('client stripe fail', err); window.location.href = form.action; }
        });
      });
    </script>
  </main>
</body>
</html>